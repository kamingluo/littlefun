!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):n.Ald=t()}(this,function(){function n(){this.concurrency=4,this.queue=[],this.tasks=[],this.activeCount=0;var n=this;this.push=function(t){this.tasks.push(new Promise(function(e,o){var r=function(){n.activeCount++,t().then(function(n){e(n)}).then(function(){n.next()})};n.activeCount<n.concurrency?r():n.queue.push(r)}))},this.all=function(){return Promise.all(this.tasks)},this.next=function(){n.activeCount--,n.queue.length>0&&n.queue.shift()()}}function t(){this.request=[],this.push=function(n){this.request.length>=10?(this.request.shift(),this.request.push(n)):this.request.push(n)},this.concat=function(){this.request.map(function(n){C.Queue.push(n)}),this.request=[]}}function e(){var n="";try{n=C.getStorageSync("aldstat_op")}catch(t){n=C.getStorageSync("aldstat_op")}if(""===n){if(""===T)return"";try{V=n=C.getStorageSync(T),n&&C.setStorageSync("aldstat_op",n)}catch(t){V=n=C.getStorageSync(T),n&&C.setStorageSync("aldstat_op",n)}}return n}function o(n){this.app=n}function r(n){Q=y(),z=n,dn=n.scene,this.aldstat=new o(this)}function a(n){var t;t=n.scene!=dn,dn=n.scene,$=0,z=n,Y=n.query.ald_share_src,Z=n.query.aldsrc||"",nn=n.query.ald_share_src,ln||(F=!1),ln=!1,(0!==K&&Date.now()-K>3e4||t)&&(pn||(N=y(),J=Date.now(),wn=0)),0!==K&&Date.now()-K<3e4&&(sn=!0),n.query.ald_share_src&&"1044"==n.scene&&n.shareTicket?C.getShareInfo({shareTicket:n.shareTicket,success:function(n){en=n,M("event","ald_share_click",JSON.stringify(n))}}):n.query.ald_share_src&&M("event","ald_share_click",1),""===on&&C.getSetting({withCredentials:!0,success:function(n){if(n.authSetting["scope.userInfo"]){C.getUserInfo({withCredentials:!0,success:function(n){var t=w();on=n,t.ufo=_(n),W=S(n.userInfo.avatarUrl.split("/")),v(t)}})}}}),D("app","show")}function s(){K=Date.now(),""===on&&C.getSetting({success:function(n){n.authSetting["scope.userInfo"]&&C.getUserInfo({withCredentials:!0,success:function(n){on=n,W=S(n.userInfo.avatarUrl.split("/"));var t=w();t.ufo=_(n),v(t)}})}}),D("app","hide")}function i(n){tn++,M("event","ald_error_message",n)}function u(n){fn=n}function c(){vn=Date.now(),un=j?this.$mp.page.route:this.route,A("page","show"),sn=!1}function f(){cn=un,wn=Date.now()-vn}function h(){cn=un,wn=Date.now()-vn}function l(){M("event","ald_pulldownrefresh",1)}function p(){M("event","ald_reachbottom",1)}function d(n){pn=!0;var t=m(n.path),e={};for(var o in z.query)"ald_share_src"===o&&(e[o]=z.query[o]);var r="";if(r=n.path.indexOf("?")==-1?n.path+"?":n.path.substr(0,n.path.indexOf("?"))+"?",""!==t)for(var o in t)e[o]=t[o];e.ald_share_src?e.ald_share_src.indexOf(X)==-1&&e.ald_share_src.length<200&&(e.ald_share_src=e.ald_share_src+","+X):e.ald_share_src=X;for(var a in e)a.indexOf("ald")==-1&&(r+=a+"="+e[a]+"&");return n.path=r+"ald_share_src="+e.ald_share_src,M("event","ald_share_status",n),n}function g(){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+n()+n()+n()+n()+n()+n()+n()}function v(n){function t(){return new Promise(function(t,e){var o={AldStat:"MiniApp-Stat",se:G||"",op:V||"",img:W};""===B||(o.ai=B),C.request({url:"https://"+E+".aldwx.com/d.html",data:n,header:o,method:"GET",success:function(n){t(200==n.statusCode?"":"status error")},fail:function(){t("fail")}})})}H.useOpen&&e(),$++,n.at=N,n.uu=X,n.v=b,n.ak=H.app_key.replace(/(\t)|(\s)/g,""),n.wsr=z,n.ifo=F,n.rq_c=$,n.ls=Q,n.te=U,n.et=Date.now(),n.st=Date.now(),H.useOpen?""===V?gn.push(t):(C.Queue.push(t),gn.concat()):C.Queue.push(t)}function w(){var n={};for(var t in rn)n[t]=rn[t];return n}function S(n){for(var t="",e=0;e<n.length;e++)n[e].length>t.length&&(t=n[e]);return t}function y(){return""+Date.now()+Math.floor(1e7*Math.random())}function _(n){var t={};for(var e in n)"rawData"!=e&&"errMsg"!=e&&(t[e]=n[e]);return t}function m(n){if(n.indexOf("?")==-1)return"";var t={};return n.split("?")[1].split("&").forEach(function(n){var e=n.split("=")[1];t[n.split("=")[0]]=e}),t}function q(n){for(var t in n)if("object"==typeof n[t]&&null!==n[t])return!0;return!1}function D(n,t){var e=w();e.ev=n,e.life=t,e.ec=tn,e.dr=Date.now()-J,Z&&(e.qr=Z,e.sr=Z),Y&&(e.usr=Y),v(e)}function A(n,t){var e=w();e.ev=n,e.life=t,e.pp=un,e.pc=cn,e.dr=Date.now()-J,pn&&(e.so=1),pn=!1,fn&&"{}"!=JSON.stringify(fn)&&(e.ag=fn),Z&&(e.qr=Z,e.sr=Z),Y&&(e.usr=Y),sn&&(e.ps=1),an?e.pdr=wn:(hn=un,an=!0,e.ifp=an,e.fp=un,e.pdr=0),v(e)}function M(n,t,e){var o=w();o.ev=n,o.tp=t,o.dr=Date.now()-J,e&&(o.ct=e),v(o)}function I(n,t,e){if(n[t]){var o=n[t];n[t]=function(n){e.call(this,n,t),o.call(this,n)}}else n[t]=function(n){e.call(this,n,t)}}function P(n){var t={};for(var e in n)"onLaunch"!==e&&"onShow"!==e&&"onHide"!==e&&"onError"!==e&&(t[e]=n[e]);return t.onLaunch=function(t){r.call(this,t),"function"==typeof n.onLaunch&&n.onLaunch.call(this,t)},t.onShow=function(t){a.call(this,t),n.onShow&&"function"==typeof n.onShow&&n.onShow.call(this,t)},t.onHide=function(){s.call(this),n.onHide&&"function"==typeof n.onHide&&n.onHide.call(this)},t.onError=function(t){i.call(this,t),n.onError&&"function"==typeof n.onError&&n.onError.call(this,t)},t}function x(n){var t={};for(var e in n)"onLoad"!==e&&"onShow"!==e&&"onHide"!==e&&"onUnload"!==e&&"onPullDownRefresh"!==e&&"onReachBottom"!==e&&"onShareAppMessage"!==e&&(t[e]=n[e]);return t.onLoad=function(t){u.call(this,t),"function"==typeof n.onLoad&&n.onLoad.call(this,t)},t.onShow=function(t){c.call(this),"function"==typeof n.onShow&&n.onShow.call(this,t)},t.onHide=function(t){f.call(this),"function"==typeof n.onHide&&n.onHide.call(this,t)},t.onUnload=function(t){h.call(this),"function"==typeof n.onUnload&&n.onUnload.call(this,t)},t.onReachBottom=function(t){p(),n.onReachBottom&&"function"==typeof n.onReachBottom&&n.onReachBottom.call(this,t)},t.onPullDownRefresh=function(t){l(),n.onPullDownRefresh&&"function"==typeof n.onPullDownRefresh&&n.onPullDownRefresh.call(this,t)},n.onShareAppMessage&&"function"==typeof n.onShareAppMessage&&(t.onShareAppMessage=function(t){var e=n.onShareAppMessage.call(this,t);return void 0===e?(e={},e.path=this.route):void 0===e.path&&(e.path=this.route),d.call(this,e)}),t}function L(n){return App(P(n))}function O(n){return Page(x(n))}function R(n){return j=!0,P(n)}function k(n){return x(n)}var H=require("./ald-stat-conf"),C="",U="wx";!function(){qq,U="qx",C=qq}();var b="8.0.0",E="qx.log";void 0===C.Queue&&(C.Queue=new n,C.Queue.all()),H.useOpen&&console.warn("提示：开启了useOpen配置后，如果不上传用户opendId则不会上报数据。");var B=function(){return void 0===C.getAccountInfoSync?"":C.getAccountInfoSync().miniProgram.appId.split("").map(function(n){return n.charCodeAt(0)+9}).join("-")}(),T=H.openKey||"",j=!1,N=y(),Q="",J=Date.now(),K=0,G="",V=e(),W="",$=0,z="",F="",X=function(){var n="";try{n=C.getStorageSync("aldstat_uuid")}catch(t){n="uuid_getstoragesync"}if(n)F=!1;else{n=g();try{C.setStorageSync("aldstat_uuid",n),F=!0}catch(n){C.setStorageSync("aldstat_uuid","uuid_getstoragesync")}}return n}(),Y="",Z="",nn="",tn=0,en="",on="",rn={},an=!1,sn=!1,un="",cn="",fn="",hn="",ln=!0,pn=!1,dn="",gn=new t,vn=0,wn=0;!function(){C.request({url:"https://"+E+".aldwx.com/config/app.json",header:{AldStat:"MiniApp-Stat"},method:"GET",success:function(n){200===n.statusCode&&(b<n.data.version&&console.warn("您的SDK不是最新版本，请尽快升级！"),n.data.warn&&console.warn(n.data.warn),n.data.error&&console.error(n.data.error))}})}(),C.aldstat=new o("");try{var Sn=C.getSystemInfoSync();rn.br=Sn.brand,rn.pm=Sn.model,rn.pr=Sn.pixelRatio,rn.ww=Sn.windowWidth,rn.wh=Sn.windowHeight,rn.lang=Sn.language,rn.wv=Sn.version,rn.wvv=Sn.platform,rn.wsdk=Sn.SDKVersion,rn.sv=Sn.system}catch(n){}C.getNetworkType({success:function(n){rn.nt=n.networkType}}),C.getSetting({success:function(n){n.authSetting["scope.userLocation"]?C.getLocation({type:"wgs84",success:function(n){rn.lat=n.latitude,rn.lng=n.longitude,rn.spd=n.speed}}):H.getLocation&&C.getLocation({type:"wgs84",success:function(n){rn.lat=n.latitude,rn.lng=n.longitude,rn.spd=n.speed}})}}),o.prototype.sendEvent=function(n,t){if(""!==n&&"string"==typeof n&&n.length<=255)if("string"==typeof t&&t.length<=255)M("event",n,t);else if("object"==typeof t){if(JSON.stringify(t).length>=255)return void console.error("自定义事件参数不能超过255个字符");if(q(t))return void console.error("事件参数，参数内部只支持Number,String等类型，请参考接入文档");for(var e in t)"number"==typeof t[e]&&(t[e]=t[e]+"s##");M("event",n,JSON.stringify(t))}else void 0===t?M("event",n,!1):console.error("事件参数必须为String,Object类型,且参数长度不能超过255个字符");else console.error("事件名称必须为String类型且不能超过255个字符")},o.prototype.sendSession=function(n){if(""===n||!n)return void console.error("请传入从后台获取的session_key");G=n;var t=w();t.tp="session",t.ct="session",t.ev="event",""===on?C.getSetting({success:function(n){n.authSetting["scope.userInfo"]?C.getUserInfo({success:function(n){t.ufo=_(n),W=S(n.userInfo.avatarUrl.split("/")),""!==en&&(t.gid=en),v(t)}}):""!==en&&(t.gid=en,v(t))}}):(t.ufo=on,""!==en&&(t.gid=en),v(t))},o.prototype.sendOpenid=function(n){if(!n||28!=n.length&&32!=n.length)return void console.error("openID不符合规则");V=n,C.setStorageSync("aldstat_op",n);var t=w();t.tp="openid",t.ev="event",t.ct="openid",v(t)};return H.plugin?{App:L,Page:O,MpvueApp:R,MpvuePage:k}:function(n){!function(){var n=App,t=Page,e=Component;App=function(t){I(t,"onLaunch",r),I(t,"onShow",a),I(t,"onHide",s),I(t,"onError",i),n(t)},Page=function(n){var e=n.onShareAppMessage;I(n,"onLoad",u),I(n,"onUnload",h),I(n,"onShow",c),I(n,"onHide",f),I(n,"onReachBottom",p),I(n,"onPullDownRefresh",l),void 0!==e&&null!==e&&(n.onShareAppMessage=function(n){if(void 0!==e){var t=e.call(this,n);return void 0===t?(t={},t.path=un):void 0===t.path&&(t.path=un),d(t)}}),t(n)},Component=function(n){try{var t=n.methods.onShareAppMessage;I(n.methods,"onLoad",u),I(n.methods,"onUnload",h),I(n.methods,"onShow",c),I(n.methods,"onHide",f),I(n.methods,"onReachBottom",p),I(n.methods,"onPullDownRefresh",l),void 0!==t&&null!==t&&(n.methods.onShareAppMessage=function(n){if(void 0!==t){var e=t.call(this,n);return void 0===e?(e={},e.path=un):void 0===e.path&&(e.path=un),d(e)}}),e(n)}catch(t){e(n)}}}()}()});